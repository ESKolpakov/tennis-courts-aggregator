<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç–µ–Ω–Ω–∏—Å–Ω—ã—Ö –∫–æ—Ä—Ç–æ–≤ –ú–æ—Å–∫–≤—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-free { color: #28a745; font-weight: bold; }
        .status-busy { color: #dc3545; font-weight: bold; }
        .updating { opacity: 0.7; }
        .last-update { font-size: 0.9em; color: #6c757d; }
        .loading-spinner {
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(0,0,0,.2);
            border-top-color: #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">üéæ –ê–≥—Ä–µ–≥–∞—Ç–æ—Ä —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Ç–µ–Ω–Ω–∏—Å–Ω—ã—Ö –∫–æ—Ä—Ç–æ–≤ –ú–æ—Å–∫–≤—ã</h1>
        
        <div class="text-center mb-4">
            <button class="btn btn-primary" id="refreshBtn">
                <span class="spinner-border spinner-border-sm d-none" role="status" id="spinner"></span>
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
            </button>
            <div class="last-update mt-2" id="lastUpdate">
                {% if update_status.last_update %}
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ update_status.last_update.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                    –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å
                {% endif %}
            </div>
            {% if update_status.error %}
                <div class="text-danger mt-2">{{ update_status.error }}</div>
            {% endif %}
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-section">
            <h5>–§–∏–ª—å—Ç—Ä—ã</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="clubFilter" class="form-label">–ö–ª—É–±</label>
                    <select class="form-select" id="clubFilter">
                        <option value="">–í—Å–µ –∫–ª—É–±—ã</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="dateFilter" class="form-label">–î–µ–Ω—å</label>
                    <select class="form-select" id="dateFilter">
                        <option value="">–í—Å–µ –¥–Ω–∏</option>
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="courtFilter" class="form-label">–ö–æ—Ä—Ç</label>
                    <select class="form-select" id="courtFilter">
                        <option value="">–í—Å–µ –∫–æ—Ä—Ç—ã</option>
                        <option value="1">–ö–æ—Ä—Ç 1</option>
                        <option value="2">–ö–æ—Ä—Ç 2</option>
                        <option value="3">–ö–æ—Ä—Ç 3</option>
                        <option value="4">–ö–æ—Ä—Ç 4</option>
                        <option value="5">–ö–æ—Ä—Ç 5</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="—Å–≤–æ–±–æ–¥–µ–Ω">–°–≤–æ–±–æ–¥–µ–Ω</option>
                        <option value="–∑–∞–Ω—è—Ç">–ó–∞–Ω—è—Ç</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="courtsTable">
                <thead class="table-dark">
                    <tr>
                        <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–ö–ª—É–±</th>
                        <th>–ù–æ–º–µ—Ä –∫–æ—Ä—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% if courts %}
                        {% for court in courts %}
                            <tr data-club="{{ court.club_name }}" data-date="{{ court.date.strftime('%Y-%m-%d') }}" data-court="{{ court.court_number }}" data-status="{{ court.status }}">
                                <td>{{ court.date.strftime('%A') }}</td>
                                <td>{{ court.time_slot }}</td>
                                <td>{{ court.club_name }}</td>
                                <td>{{ court.court_number }}</td>
                                <td>
                                    <span class="status-{{ 'free' if court.status == '—Å–≤–æ–±–æ–¥–µ–Ω' else 'busy' }}">
                                        {{ court.status }}
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <div class="text-center mt-4 text-muted small">
            <p>–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç. –ò—Å—Ç–æ—á–Ω–∏–∫–∏: YClients, FindSport, Tsaritsyno Tennis</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refreshBtn = document.getElementById('refreshBtn');
            const spinner = document.getElementById('spinner');
            const courtsTable = document.getElementById('courtsTable');
            const lastUpdate = document.getElementById('lastUpdate');
            const tableBody = document.getElementById('tableBody');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const clubFilter = document.getElementById('clubFilter');
            const dateFilter = document.getElementById('dateFilter');
            const courtFilter = document.getElementById('courtFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            // –í—Å–µ –¥–∞–Ω–Ω—ã–µ
            let allData = [];
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
            function populateFilterOptions(data) {
                // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                clubFilter.innerHTML = '<option value="">–í—Å–µ –∫–ª—É–±—ã</option>';
                dateFilter.innerHTML = '<option value="">–í—Å–µ –¥–Ω–∏</option>';
                
                // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                const clubs = [...new Set(data.map(item => item.club))];
                const dates = [...new Set(data.map(item => item.date))];
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ü–∏–π
                clubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club;
                    option.textContent = club;
                    clubFilter.appendChild(option);
                });
                
                dates.sort().forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                    const dateObj = new Date(date);
                    const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
                    const monthNames = ['–Ø–Ω–≤–∞—Ä—è', '–§–µ–≤—Ä–∞–ª—è', '–ú–∞—Ä—Ç–∞', '–ê–ø—Ä–µ–ª—è', '–ú–∞—è', '–ò—é–Ω—è', '–ò—é–ª—è', '–ê–≤–≥—É—Å—Ç–∞', '–°–µ–Ω—Ç—è–±—Ä—è', '–û–∫—Ç—è–±—Ä—è', '–ù–æ—è–±—Ä—è', '–î–µ–∫–∞–±—Ä—è'];
                    option.textContent = `${dateObj.getDate()} ${monthNames[dateObj.getMonth()]} ${dayNames[dateObj.getDay()]}`;
                    dateFilter.appendChild(option);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã
            function filterTable() {
                const clubValue = clubFilter.value;
                const dateValue = dateFilter.value;
                const courtValue = courtFilter.value;
                const statusValue = statusFilter.value;
                
                const rows = tableBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const rowClub = row.getAttribute('data-club');
                    const rowDate = row.getAttribute('data-date');
                    const rowCourt = row.getAttribute('data-court');
                    const rowStatus = row.getAttribute('data-status');
                    
                    let showRow = true;
                    
                    if (clubValue && rowClub !== clubValue) showRow = false;
                    if (dateValue && rowDate !== dateValue) showRow = false;
                    if (courtValue && rowCourt !== courtValue) showRow = false;
                    if (statusValue && rowStatus !== statusValue) showRow = false;
                    
                    row.style.display = showRow ? '' : 'none';
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            clubFilter.addEventListener('change', filterTable);
            dateFilter.addEventListener('change', filterTable);
            courtFilter.addEventListener('change', filterTable);
            statusFilter.addEventListener('change', filterTable);
            
            async function updateData() {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('updating');
                spinner.classList.remove('d-none');
                
                try {
                    const response = await fetch('/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        const checkStatus = async () => {
                            const statusResponse = await fetch('/status');
                            const status = await statusResponse.json();
                            
                            if (!status.is_updating) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                                await loadTableData();
                                refreshBtn.disabled = false;
                                refreshBtn.classList.remove('updating');
                                spinner.classList.add('d-none');
                            } else {
                                setTimeout(checkStatus, 1000);
                            }
                        };
                        
                        checkStatus();
                    } else {
                        throw new Error(result.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                    refreshBtn.disabled = false;
                    refreshBtn.classList.remove('updating');
                    spinner.classList.add('d-none');
                }
            }
            
            async function loadTableData() {
                try {
                    const response = await fetch('/data');
                    const data = await response.json();
                    
                    allData = data;
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                    populateFilterOptions(data);
                    
                    // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                    tableBody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –∫–æ—Ä—Ç–æ–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-club', item.club);
                        row.setAttribute('data-date', item.date);
                        row.setAttribute('data-court', item.court_number);
                        row.setAttribute('data-status', item.status);
                        
                        row.innerHTML = `
                            <td>${item.day_of_week}</td>
                            <td>${item.time}</td>
                            <td>${item.club}</td>
                            <td>${item.court_number}</td>
                            <td>
                                <span class="status-${item.status_class}">
                                    ${item.status}
                                </span>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
                    filterTable();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    const statusResponse = await fetch('/status');
                    const status = await statusResponse.json();
                    if (status.last_update) {
                        lastUpdate.textContent = '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + 
                            new Date(status.last_update).toLocaleString('ru-RU');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                    `;
                }
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            refreshBtn.addEventListener('click', updateData);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadTableData();
        });
    </script>
</body>
</html>